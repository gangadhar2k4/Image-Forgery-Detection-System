{% extends "base.html" %}

{% block title %}Analysis History - Forgery Detection{% endblock %}

{% block content %}
<div class="history-container">
    <h1 class="page-title">Analysis History</h1>
    <p class="page-subtitle">View all previously analyzed images and their results</p>

    <div class="loading-section" id="loadingSection">
        <div class="spinner"></div>
        <p>Loading history...</p>
    </div>

    <div class="history-grid" id="historyGrid" style="display: none;">
    </div>

    <div class="empty-state" id="emptyState" style="display: none;">
        <div class="empty-icon">ðŸ“­</div>
        <h2>No Analysis History Yet</h2>
        <p>Upload and analyze an image to get started</p>
        <a href="/upload" class="btn btn-primary">Analyze Image</a>
    </div>

    <div class="error-section" id="errorSection" style="display: none;">
        <p id="errorText"></p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    window.addEventListener('DOMContentLoaded', () => {
        loadHistory();
    });

    function loadHistory() {
        fetch('/api/history')
            .then(response => response.json())
            .then(data => {
                document.getElementById('loadingSection').style.display = 'none';
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                if (data.history.length === 0) {
                    document.getElementById('emptyState').style.display = 'block';
                } else {
                    displayHistory(data.history);
                }
            })
            .catch(error => {
                document.getElementById('loadingSection').style.display = 'none';
                showError('Failed to load history: ' + error.message);
            });
    }

    function displayHistory(history) {
        const grid = document.getElementById('historyGrid');
        grid.style.display = 'grid';
        grid.innerHTML = '';

        history.forEach(entry => {
            const card = document.createElement('div');
            card.className = 'history-card';
            
            const date = new Date(entry.timestamp);
            const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            
            card.innerHTML = `
                <div class="history-image">
                    <img src="${entry.original_path}" alt="${entry.filename}" onerror="this.src='/static/placeholder.jpg'">
                </div>
                <div class="history-info">
                    <h3>${entry.filename}</h3>
                    <div class="verdict-small">
                        <span class="badge badge-${entry.color}">${entry.verdict}</span>
                    </div>
                    <p><strong>Confidence:</strong> ${entry.confidence}%</p>
                    <p><strong>Date:</strong> ${formattedDate}</p>
                    <div class="history-actions">
                        <a href="/analysis/${entry.filename}" class="btn btn-secondary btn-small">View Details</a>
                        ${entry.report_path ? `<a href="${entry.report_path}" download class="btn btn-secondary btn-small">Download Report</a>` : ''}
                        <button class="btn btn-danger btn-small" onclick="deleteEntry(${entry.id})">Delete</button>
                    </div>
                </div>
            `;
            
            grid.appendChild(card);
        });
    }

    function deleteEntry(id) {
        if (!confirm('Are you sure you want to delete this analysis entry?')) {
            return;
        }

        fetch(`/api/history/delete/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                loadHistory();
            }
        })
        .catch(error => {
            alert('Delete failed: ' + error.message);
        });
    }

    function showError(message) {
        document.getElementById('errorText').textContent = message;
        document.getElementById('errorSection').style.display = 'block';
    }
</script>
{% endblock %}
